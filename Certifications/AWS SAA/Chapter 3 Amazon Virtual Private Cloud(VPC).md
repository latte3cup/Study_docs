#### VPC
- 퍼블릭/프라이빗 영역을 논리적으로 분리 및 격리
- VPC  + VPN, DirectConnect 등과의 결합으로 데이터 센터를 클라우드로 확장 가능
- IP 주소 및 범위 , 프라이빛 밀 퍼블릭 서브넷, 라우팅 테이블, 네트워크 게이트웨이 활용 가능

---- 
#### VPC 생성 단계
1. CIDR 블록 할당 -> 리전 하나에만 속함  --> VPC 자체의 범위를 지정
2. 서브넷 할당  ->  AZ 별 서브넷 할당 --> VPC 내에서 결정 및 AZ 선택
  - CIDR 블록은 /16 ~ /28까지
  - 라우팅 테이블은 범위가 좁은 규칙을 우선 적용
3. VPC에 게이트웨이 부착

##### NAT : 네트워크 주소 변환
- 이 밑3가지는 모두 stateful함. 
1. NAT 인스턴스 : 수동 구성형
  - 고전적인 방법으로 NAT 게이트웨이보단 쌈
  - EC2를 띄워서  리눅스내에 iptables,ip_forward,route,nftables를  직접 설정하는 것
	`퍼블릭 서브넷에 위치 - 퍼블릭 IP를 갖고 IGW로 나가야 함`
	`퍼블릭 IP(EIP) 부여 - 외부와 통신 가능해야 함`
	`EC2 설정 변경 - IP 포워딩과 소스/데스티네이션 체크 비활성화 필요`
	`보안 그룹 - 프라이빗 서브넷 → NAT 인스턴스 → IGW 흐름 허용 필요`
	`라우팅 테이블 - 프라이빗 서브넷의 `0.0.0.0/0`을 NAT 인스턴스 ENI로 지정`
2. NAT 게이트웨이 :  elasticIP(퍼블릭 IP ) 설정하면 자동 관리하여 NAT 적용
  - 물론 비용 들어감, 하지만 인스턴스보다는 더 높은 대역폭.
  - 인스턴스 -> 게이트웨이 전환 시 주소를 끊고 게이트웨이에 할당해야함
  - ipv4 트래픽에 대해서만 적용 및 관리

  ###### **외부(송신) 전용 게이트웨이 (Egress-Only**) - ipv6에만 사용
  - Egress, 즉 아웃바운드 허용. Ingress - 인바운드 허용하지 않음
  - ipv6는 공인 Ip, 즉 글로벌 유효 주소를 사용하기 떄문에 직접 접근이 가능함
  - 따라서 인그레스는 거부하고 이그레스만 허용함으로써 보안을 적용

#### 탄력적 네트워크 인터페이스
- 해당 기능은 EC2에 있긴함.
- **ENI는 EC2의 네트워크 기능을 담당하는 필수 구성 요소 중 하나**
- EC2에 붙는 가상 네트워크 카드라 보면됨.
- 다음에 대해 장점이 있음
	- **장애 전환(HA)**: ENI를 장애 난 EC2에서 → 대기 중 EC2로 붙이면 IP/보안그룹 그대로 유지
	- **보안 정책 분리**: ENI마다 다른 **보안 그룹**을 적용해 트래픽을 나눌 수 있음
	- **네트워크 다중화**: EC2에 ENI 여러 개 붙여서 내부망/외부망을 분리함
- **ENI는 네트워크 “라우팅/연결/보안”의 논리적 단위이지, 전송 속도(대역폭) 자체를 직접 제한하거나 결정하지 않음. 


###### 향상된 네트워킹 (리눅스) - 안중요한듯

| 인스턴스 세대   | 대표 타입 예시                      | 가상화 방식       | 향상된 네트워킹 지원 | 드라이버          | VF 사용 여부  | RDMA/EFA 지원 |
| --------- | ----------------------------- | ------------ | ----------- | ------------- | --------- | ----------- |
| 구세대 (Xen) | `t2`, `m3`, `c3`              | Xen          | ❌ (미지원)     | –             | ❌         | ❌           |
| 과도기 세대    | `m4`, `c4`, `r4`              | Xen + SR-IOV | ✅ (선택)      | `ixgbevf`     | ✅ (노출됨)   | ❌           |
| 최신 세대     | `m5`, `c5`, `t3`, `r5`, `c6i` | Nitro (KVM)  | ✅ (기본 지원)   | `ena`         | ✅ (숨김)    | ❌           |
| 고성능 HPC   | `c5n`, `p4d`, `u-6tb1.metal`  | Nitro        | ✅ (기본)      | `ena` + `efa` | ✅ (내부 사용) | ✅           |
| EFA only  | `efa-enabled metal 인스턴스`      | Nitro        | ✅ (EFA 전용)  | `efa` only    | ✅         | ✅ (RDMA 전용) |

#### Elastic Ip 주소
- EC2 인스턴스가 종료되거나 재시작되어도 변하지 않는 공인 IP 주소
- 기본 설정은 Ec2 생성마다 하나의 새로운 IP 가 만들어짐 - 정확히 하나의 ENI에 EIP가 붙는 구조
- 결국 NAT 구성이 포함되므로 IPv4만 지원함 (IPv6는 공인이므로 필요가 없음)
- 퍼블릭 IP와 EIP를 사용하는 경우

| 항목                             | **퍼블릭 IP (Public IP)** | **탄력적 IP (Elastic IP, EIP)** |
| ------------------------------ | ---------------------- | ---------------------------- |
| **할당 방식**                      | EC2 생성 시 자동 할당 가능      | 사용자가 명시적으로 생성 후 할당           |
| **유지 여부**                      | 인스턴스 종료 시 소멸           | 인스턴스 종료 후에도 유지됨              |
| **이동 가능성**                     | ❌ 불가 (인스턴스에 종속)        | ✅ 다른 인스턴스로 이동 가능             |
| **요금 정책**                      | 무료                     | **사용 중 무료 / 미사용 시 과금**       |
| **탄력성 (이름 의미)**                | 없음                     | 인스턴스 간 이동 가능 = 고가용성          |
| **보조 IP에 부여 가능**(Secondary IP) | ❌ (기본 프라이빗 IP만)        | ✅ 모든 프라이빗 IP에 가능             |
| **운영 목적**                      | 단순 외부 연결               | 고정 IP 유지, 장애 대응 등 아키텍처 설계 목적 |
		보조 IP의 도입 목적 : ‘IP 기반으로 리소스/트래픽/보안/운영을 분리하는 설계 도구**

---- 
#### 네트워크 보안
- VPC에서 네트워킹을 통해 실행되는 리소스의 보안을 유지
- 보안 그룹 및 접근제어목록(NACL) 을 통해 구현

##### 보안 그룹 (시큐리티 그룹)
- 보안 그룹은 VPC내 실행되는 어떤 인스턴스에도 할당할 수 있는 가상 방화벽
- **인스턴스 단위**이므로 EC2 생성시 보안그룹 할당이 권장
- 인스턴스별 최대 5개의 그룹을 부여 가능, **스테이트풀함.**
- IP주소, 포트 ,트래픽의 인/아웃 바운드에 대한 규칙을 정의한 프로토콜 등으로 구성
- 인바운드는 기본적으로 모두 차단하며, **인/아웃이든** **허용 규칙만 작성 가능**
-  규칙이 아닌 Ec2 아웃바운드 트래픽에 대한 응답은 인바운드가 자동으로 적용됨 **(stateful)**
- 생성에는 명시가 안되지만 , 가입 시 생성되는 보안그룹에는 보안그룹에 대한 인바운드가 디폴트로 설정되어 있음
- ENI에 붙어서 실제 인스턴스의 보안 및 트랙을 관리하는 역할을 함.

##### 네트워크 액세스 제어 목록 (Network Access Control List)
- **서브넷 단위**로 방화벽 적용
- 일반적으로 인스턴스 생성 시 보안 그룹을 반드시 지정하나 ACL은 없으며, 기본 NACL이 사용됨
- default NACL은 인/아웃바운드가 모두 개방되어 있음
- 커스텀으로 NACL을 만들면기본적 옵션으로, 인/아웃 바운드는 모두 차단되어있음
- 트래픽 규칙을 숫자를 통해 우선순위를 조절하며, 오름차순으로 높은 우선순위를 가짐
- 선순위가 먼저 적용된 경우 후순위의 규칙은 무시된다.
- 우선순위의 `*`은 암시적 거부를 의미. 우선순위상 제일 마지막.
- NACL은 StateLess함. 즉 인/아웃 트래픽은 무조건 규칙에 따름. 아웃을 설정했으나 인을 안하거나 그 반대의 경우에도 통신이 되지 않음.
- NACL은 허용/거부를 명시적으로 지정 가능.

※ 시큐리티 그룹은 리전당 VPC마다 500개, 각 50개의  인/아웃바운드 규칙, ENI당 SG는 5개 요청을 통해 최대 16개까지 가능.

---
#### VPC 피어링
- VPC 간의 피어링을 통해 서로 통신 및 리소스 공유 가능 (리전 관계 없음)
- VPC 피어링 설정과정
	1. 먼저 A가 B에게 특정 VPC에 대한 피어링 연결 요청을 함, B가 수락시 목록에 추가됨
	2. 그 후 A B 모두 해당 VPC 라우팅 테이블에 직접 각 상대 VPC 주소에대한 피어링 라우트 엔트리를 추가해야함.
	3. 이후 연결 됨. 하지만 효율적으로 관리하기 위해 보안그룹이나 DNS 등 연결설정 내용을 수정해야할 수 있음. (예: `DNS resolution for peering` 활성화)
특히 (예: `DNS resolution for peering` 활성화)를 하지 않으면 상대 퍼블릭 호스트네임 사용시 VPC 피어링을 거치는 것이 아닌 인터넷을 거칠 수 있음
활성화 후 호스트네임이 프라이빗 IP로 확인된다.
-  VPC는 오직 1대1 로 3개 이상의 피어링을 연결하려면 메쉬형태로 서로서로가 연결해야함.
- 각 VPC의 CIDR 블록이 겹치면 피어링 불가

##### VPC 엔드포인트
- AWS VPC(가상 사설 클라우드) 내부 리소스가  **인터넷을 거치지 않고, AWS 서비스(글로벌/리전별 서비스) 또는  다른 VPC 서비스와 “프라이빗 네트워크”를 통해 직접 통신**할 수 있도록  제공하는 **네트워크 접점(Endpoint) 기능**
- 이 연결은 private 함. 즉 어떤 트래픽도 아마존 네트워크를 벗어나지 않음.
- 이떄 AWS PrivateLink를 사용하게 되는 데 이는 아마존 네트워크를 통해 내부 처리하는것
- 엔드포인트 종류는 여러개 있지만 핵심 5종류만 말하겠음 

|엔드포인트 종류|주요 대상 및 특징|주 사용처|
|---|---|---|
|**게이트웨이 엔드포인트**|S3, DynamoDB 전용, 라우팅 테이블에 등록, 프라이빗 트래픽, 대역폭 무제한, 별도 IP 없음|S3/DynamoDB 대용량 입출력, 정책 기반 프라이빗 통신|
|**인터페이스 엔드포인트**|ENI(프라이빗 IP), TCP/UDP, DNS로 프라이빗 연결, PrivateLink 기반, 세밀한 SG 제어|SQS, SNS, SaaS, 타 계정 서비스, API Gateway 등|
|**게이트웨이 로드밸런서 엔드포인트**|GWLB 연동, L3/L4 보안 어플라이언스 트래픽 분산, 라우팅 테이블로 연결|트래픽 인스펙션, 방화벽, 네트워크 체이닝|
|**리소스 엔드포인트**|개별 리소스(EC2, DB, 온프레미스 IP 등) 직접 연결, 로드밸런서 불필요, 중앙 정책 관리|VPC Lattice, 온프레미스 연동|
|**서비스 네트워크 엔드포인트**|하나의 엔드포인트로 여러 리소스/서비스 일괄 접근, 서비스 네트워크 기반 중앙화된 정책|VPC Lattice 기반 서비스 메쉬 구조|
※ **Amazon VPC Lattice(라티스)는  기존의 복잡한 VPC 네트워크(서로 다른 VPC, 리전, 온프레미스, 서비스 간 연결 등)를  “서비스 중심”으로 더 쉽게,  일관되게, 그리고 중앙에서 관리할 수 있도록 만든  차세대 네트워킹 서비스**입니다.


#### Transit Gateway
- VPC 피어링을 full mesh 구조이므로 늘어나면 복잡하고 관리가 힘듬
- Transit Gateway를 통해 모든 VPC와 **온프레미스 네트워크**를 하나의 게이트웨이에 집중하여 연결, 즉 게이트웨이가 스타형(허브-스포크(Hub-and-Spoke)) 구조의 중심에 자리잡게 됨
- **3계층 ip 기반으로 라우팅** - 즉 패킷 Ip 목적지를 보고 다음 홉(next hop) 결정
- 시간당 연결 요금 + 전송 데이터 처리 요금(GB 단위), 크로스리전인 경우 별도의 과금 추가.
- 온프레미스와도 연결할수 있다는게 중요ㅕ

---
#### DNS와 VPC
- 일반 DNS도 호스트네임 + 도메인 네임으로 구성됨 (FQDN: Fully Qualified Domain Name)
	`[FQDN]           : www.example.com.
	`[Hostname]       : www`  - 같은 네트워크·도메인 내에서 **개별 장치를 구분하는 이름**  
	`[Domain Name]    : example.com` - **호스트가 속한 네임스페이스(영역)** 를 나타내는 이름
	`[TLD]            : com` - 인터넷 주소 체계에서 “마지막 구분자”이자 최상위 범주
- 모든 인스턴스는 반드시 프라이빗 IP를 가짐 (VPC 내부 통신을 위해 당연히 있어야함)
- 또한 프라이빗 DNS 호스트 네임도  VPC 설정에 따라 자동 부여 가능함.
- 퍼블릭 IP 는 기본 VPC엔 자동 부여되어있으나 커스텀 VPC는 비활성화되어 있음
- `enableDnsHostnames` - 이는 퍼블릭/프라이빗 상관없이 DNS를 사용할 것인지 옵션
- `enableDnsSupport` - AWS DNS 서버를 사용 - 즉 실제 DNS 변환 담당. 
- 둘다 참이어야 작동하는것.

##### DHCP 옵션 세트 (Dynamic Host Configuration Protocol)
- 기본 도메인 네임 ,  DNS 서버 주소 등 VPC 인스턴스의 호스트 환경 설정에 사용
- DHCP 옵션 세트는 자동으로 VPC에 추가됨.
- 특히 DNS 서버를 AmazonProvidedDNS 라는 서버에 자동을 가리키도록 되어 있음
- DHCP 옵션 세트는 생성 후 수정 불가하며 새로 만들어야됨
- DHCP 통신은 인스턴스 부팅·재연결·임대갱신·환경변경 때마다 작동 
- 그 뒤 DHCP 통신 응답으로 DNS 서버 주소를 받으므로 그 후 인스턴스와 DNS 서버가 통신.


- DHCP 옵션 세트 필드 목록

|필드 이름|설명|기본값 (서울 리전 예시)|예시 설정 값|
|---|---|---|---|
|**domain-name**|인스턴스가 속할 기본 도메인 이름(FQDN의 도메인 부분)|`ap-northeast-2.compute.internal`|`corp.local`|
|**domain-name-servers**|인스턴스가 사용할 DNS 서버 주소 목록|`AmazonProvidedDNS` (VPC CIDR+2)|`AmazonProvidedDNS`, `8.8.8.8`|
|**ntp-servers**|NTP(Network Time Protocol) 서버 주소|없음|`169.254.169.123`(AWS Time Sync), `10.0.0.10`|
|**netbios-name-servers**|NetBIOS 이름 서버(WINS) 주소(Windows 네트워크용)|없음|`10.0.0.5`|
|**netbios-node-type**|NetBIOS 이름 해석 방식|없음|`1`(B-node), `2`(P-node), `4`(M-node), `8`(H-node)|

--- 

##### 외부에서 VPC에 연결
- 해당 종단을 모두 구성해야됨 (ipsec  터널 구성)
1.  Virtual Private Gateway
  - AWS 측 VPN 종단 장치, VPC에 연결되어 AWS 네트워크와 VPN 터널 형성
  - Site-to-Site VPN 또는 Direct Connect에서 **AWS 쪽 엔드포인트**
  - 하나의 VPC에만 연결 가능
2.  Customer Gateway
  - 기업(온프레미스) 네트워크 측 끝단
  - 온프레미스 전용 vpn 클라이언트 사용
  - 공인 IP 필수
  - VPN 라우팅 방식을 BGP 또는 Static으로 설정

- 주요 연결 옵션 방법

| 방식             | AWS 측 끝단                                       | 온프레미스 끝단   | 주 라우팅  | 주요 용도                                                                                                                                                                                                                  |
| -------------- | ---------------------------------------------- | ---------- | ------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 하드웨어 VPN       | **VGW/TGW**                                    | **CGW**    | 정적/BGP | 빠른 구축, 백업 회선, 지점 연결 ([AWS 문서](https://docs.aws.amazon.com/vpn/latest/s2svpn/how_it_works.html?utm_source=chatgpt.com "How AWS Site-to-Site VPN works"))                                                                |
| Direct Connect | **DXGW/TGW/VGW**      (Direct Connect Gateway) | 전용선 라우터    | BGP    | 안정/저지연, 대역폭·비용 최적화 ([AWS 문서](https://docs.aws.amazon.com/directconnect/latest/UserGuide/Welcome.html?utm_source=chatgpt.com "AWS Direct Connect Locations"))                                                           |
| VPN CloudHub   | **VGW**                                        | 다수 **CGW** | BGP    | 지점↔지점 허브-스포크 중계 ([AWS 문서](https://docs.aws.amazon.com/whitepapers/latest/aws-vpc-connectivity-options/aws-vpn-cloudhub.html?utm_source=chatgpt.com "AWS VPN CloudHub"))                                                |
| Software VPN   | **EC2(자체 VPN)**                                | SW/장비      | 구현에 따름 | 커스텀 기능/프로토콜, 소규모·특수 용도 ([AWS 문서](https://docs.aws.amazon.com/whitepapers/latest/aws-vpc-connectivity-options/introduction.html?utm_source=chatgpt.com "Introduction - Amazon Virtual Private Cloud Connectivity ...")) |
|                |                                                |            |        |                                                                                                                                                                                                                        |
상세 참고 [[AWS VPC 프라이빗 연결 4가지]]

---

###### VPC 흐름 로그
-  VPC 내외부 트래픽 흐름에 대한 로그 확인
- Amazon CloudWatch로 저장 및 확인 가능
- 비용은 CLoudWatch

