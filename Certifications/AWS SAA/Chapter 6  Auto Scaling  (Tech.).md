### Auto Scaling
- 사전에 정의한 조건과 정책에 따라 컴퓨팅 리소스를 자동으로 확대 또는 축소하는 기술.
- 클라우드가 제공하는 탄력성에 의해 만들어지고 사용자 요구를 반영하는 기술
- 실제 산업에서 피크 워크로드를 예측하는 건 불가능에 가까워서 해당 기술의 효용성 증가.
- 성능과 가용성을 유지하면서 비용을 최적화하는 기능
-  AWS Auto Scaling은 수평 확장 중심으로서 Scale In/Out, Relacement까지를 포함.
 
#### Auto Scaling 장점
- 동적 스케일링 : 사용자의 요구 수준에 따라 리소스를 동적 스케일링, 보통 제한 없음
- 최상의 사용자 경험 및 성능 향상 : 리소스가 항상 적정 수준 및 최적화 상태에서 실행됨. 규칙을 통해 최상의 사용자 경험 제공 가능
- 헬스 체크와 서버 플릿 관리 :  
	  - 헬스 체크는 인스턴스나 서버가 정상적으로 요청을 처리할 수 있는지 주기적으로 검사하는 과정. 비정상 리소스를 감지하고 교체하여 장애 시간 최소화
	  - 서버 플릿은 동일하거나 유사한 역할을 수행하는 서버 인스턴스들의 집합
	  - AWS에서는 **EC2 Auto Scaling 그룹**이나 **GameLift Fleet** 같은 형태로 관리
	  - 목적은 **규모 확장**, **부하 분산**, **유지보수 용이성**
- 로드 밸런싱 
- 타깃 트래킹 : 확장 정책 중 하나로,  지정한 지표(metric)가 **목표값(Target Value)** 을 유지하도록 인스턴스 수를 자동으로 늘리거나 줄이는 방식
- 리소스 비용 관리 : 불필요한 리소스를 제거해 예산 낭비를 막음
- 예측정 확장 : Auto Scaling은 머신러닝과 통합외어 있어 수요 예측지에 근거하여 자동으로 확장 축소 가능. 실제 EC2 사용량 정보를 수집한 뒤 ML을 통해 예측


###### 스케일 업/다운 서비스
- DynamoDB Auto Scaling
- Aurora Serverless v2 등 +(스케일 아웃/인)

---
#### AWS Auto Scaling절차 흐름

1. **리소스 먼저 생성**
    - EC2 → Auto Scaling 그룹 생성
    - DynamoDB → 테이블 생성
    - Aurora → 클러스터 생성
2. **AWS Auto Scaling 콘솔로 이동**
    - “조정 계획 생성” 클릭
3. **대상 리소스 선택**
    - 기존에 만든 Auto Scaling 그룹, DB, ECS 서비스 등 선택
4. **스케일링 방식 설정**
    - 목표 추적(Target Tracking)
    - 예약 스케일링(Scheduled Scaling)
    - 예측 스케일링(Predictive Scaling)
5. **검토 후 생성**
    - CloudWatch와 연동되어 자동 확장/축소 시작

#### 1. 조정 계획 생성 - 조정 가능한 리소스 찾기
1. CloudFormation 스택별 검색
	-  AWS CloudFormation으로 만든 리소스만 대상(EC2 Auto Scaling 그룹, ECS 서비스, DynamoDB 테이블 등)
	- CloudFormation 템플릿으로 배포한 경우, 해당 스택 이름을 기준으로 검색해 선택
2. 태그로 검색
	- 리소스에 부여된 **태그(Key-Value)** 를 기준으로 검색
	- Aurora DB 클러스터, Auto Scaling 그룹, DynamoDB 테이블과 보조 인덱스에서도 태그 이용 가능
3. EC2 Auto Scaling 그룹 
	- 이미 존재하는 EC2 Auto Scaling 그룹을 직접 선택
	- 조정 계획에 포함할 Auto Scaling 그룹을 지정하고, 이후 목표 추적(타깃 트래킹), 예약 스케일링 등을 설정

#### 2. 조정 계획 생성 - 조정 전략 지정
- 스케일링 전략은 (운영 목표 기반의 옵션) 총 4가지가 있음

|전략|설명|장점|단점|적합 사례|
|---|---|---|---|---|
|**가용성 기준 최적화**(Optimize for availability)|수요 변화에 빠르게 대응해 가용성을 최우선으로 유지. Scale Out 속도 빠르고, Scale In은 느림.|순간 부하 폭증에도 안정성 보장|유휴 리소스가 많아 비용 증가 가능|게임 서버 채널, 금융 거래 서버 등 순간 트래픽 급증 환경|
|**가용성과 비용의 균형**(Balanced availability and cost)|성능과 비용 절감을 균형 있게 유지. Scale Out/Scale In 반응 속도 모두 중간 수준.|대부분의 서비스에 안정적인 선택|순간 부하 대응이 가용성 중심보다 다소 느림|일반 웹 서비스, API 서버, SaaS|
|**비용 기준 최적화**(Optimize for cost)|비용 절감을 최우선. Scale In 속도 빠르고, Scale Out은 느림.|리소스 사용 최소화로 비용 절감 극대화|부하 급증 시 성능 저하 가능|트래픽 예측이 가능한 내부 백엔드, 배치 처리|
|**사용자 지정**(Custom)|사용자가 직접 확장/축소 민감도, 쿨다운 시간 등 모든 파라미터를 설정.|상황별로 최적화 가능|잘못 설정 시 과도한 증감 또는 성능 저하 위험|특수한 부하 패턴이나 세밀 제어가 필요한 서비스|
- 이 4가지마다 **예측 스케일링 옵션 + 동적 스케일링 옵션** 추가 가능
- 예측 스케일링은 “미리 대비”, 동적 스케일링은 “실시간 보정”  
- 전략은 이 두 가지 스케일링 방식에서 **얼마나 여유를 둘지, 얼마나 빨리 반응할지**를 결정하는 기준이 됨

---
#### EC2 Auto Scaling 활용
- EC2만 대상
- 각종 EC2 정보에 따라 스케일링 그룹에 연결. 오직 1대1 매칭
- 스케일링 그룹은 생성 후 변경 불가.

##### Auto Scaling Group (ASG)
- 스케일업 & 스케일 다운 규칙의 모음.
- 스케일링 유형
	1. **인스턴스 레벨 유지**  (기본 스케일링 계획)  :  항상 유지하고자 하는 인스턴스의 갯수를 정의. 
	2. **수동 스케일링** : 콘솔이나 API,CLI를 통한 스케일링 작업 실행. 수동이므로 비추
	3. **요구별 스케일링** : 시스템의 요구 수준에 맟추는 방식 CloudWatch가 모니터링하는 리소스 지표를 바탕으로 요구 수준에 맟춰 스케일링 규칙을 수립. 반드시 스케일 업 정책, 스케일 다운 정책 2가지를 모두 수립해야함.
	4. **일정별 스케일링** : 트래픽의 변화를 예측 가능한 경우 추천.
- 반드시 최소한의 인스턴스를 정의해야함. 스케일업 상황의 최대 인스턴스 수도 정의
- 스케일업/다운 조건 파악이 중요하므로 Amazon SnS 등으로 알림받는게 좋음.
- Scaling 그룹은 개수 제한이 있지만 개수제한의 변경은 가능함. 다만 특정 리전을 벗어날 수 없음
- 스케일링 정책 유형
	1. **심플 스케일링** : 단 하나의 메인 정책(이벤트)에 따라 스케일링 업&다운. 리소스 지표 수준에 따른 인스턴스 추가 및 삭제. 또한 인스턴스 시작 / 정지 를 위한 대기 시간도 정의 가능(쿨다운 기간). (하나의 이벤트 ,하나 액션)
	   ex) CPU 사용률 ≥ 70% → 인스턴스 +1 , CPU 사용률 ≤ 30% → 인스턴스 -1
	   하지만 세밀한 대응이 어렵고, 인스턴스가 들쭉날쭉 바뀌는 플랩(flapping) 현상 발생 가능
	2. **단계적 심플 스케일링** : 이벤트(CloudWatch)에 반응해 스케일링(1이랑 같음). 다만 이벤트 발생시 단일 조치가 아닌 임계치 범위에 따라 다르게 반응 (하나의 이벤트 ,여러 액션)
	   ex) CPU ≥ 60% 이벤트 → +1, CPU ≥ 80% 이벤트 → +2
	   하지만 설계가 복잡하고, 관리가 부담
	3. **타깃 트래킹 스케일링 정책** : 1,2와 다르게 이벤트 기반이라기 보다는 지속적 제어(Feedback Control). 사용자는 다른건 다 똑같이 정해주지만 세밀한 인스턴스 수의 증감은 정하지 않음. 
	   지표 선택, 목표값 정의, 인스턴스 개수 범위, 워밍업 시간등을 지정하여. ASG가 CloudWatch와 지속적으로 통신하여 지정한 지표의 목표값을 일정하게 유지하여 스케일링을 자동 조정.
	   ex) 에어컨 온도 24도에 맟추면 알아서 에어컨이 조절.
- **인스턴스 삭제 정책 : 스케일 다운 정책과 역할이 다름**
	 : 이는 스케일 다운시 **어떤 인스턴스를 우선적으로 종료**할지 결정하는 규칙
    - AWS 기본 종료 우선순위(Default Termination Policy):
	    1. 여러 AZ에 분산되어 있으면, **가장 많은 인스턴스가 있는 AZ에서 제거** (AZ 균형 유지).
	    2. 다음으로, **스케일링 그룹에서 가장 오래된 인스턴스** 제거.
	    3. 같은 나이의 인스턴스가 여러 개라면, **기본 설정대로 임의 선택**.
	- 추가 설정 가능한 정책
		1. **OldestInstance**: 가장 오래된 인스턴스부터 종료.
		2. **NewestInstance**: 가장 최근에 생성된 인스턴스부터 종료.
		3. **ClosestToNextInstanceHour**: 과금 시간 단위(1시간/초단위)에 가장 가까운 인스턴스를 종료해 비용 최적화. --> 과거 시간(hour) 단위에서 의미 있었음 지금은 초단위
		4. **OldestLaunchConfiguration / OldestLaunchTemplate**: 이전 버전 템플릿으로 만든 인스턴스를 우선 종료.

---
#### Elastic load Balancing
- 일반 온프레미스의 로드밸런스의 최대 난제는 SPOF(단일 장애점)의 해결임
- ELB는 물리적으로 여러개인 로드밸런서를 추상화하여 ELB 서비스로 제공
- 주요 장점
	1. 탄력성(Elasitc) : 최대 강점 - 자동적 확장성. 인스턴스 추가/삭제에 대한 어떠한 수작업이 필요 없음.
	2. 통합성(Integrated) :  다양한 AWS 서비스와 통합가능.
	3. 안전성(Secured) : 통합 인증 관리, SSL 복호화, 포트 포워딩 기능을 제공
	   리스너 규칙등을 통해 트래픽을 효과적으로 통제
	4. 고가용성(High available) : 다수 AZ에 분산 및 다중 노드 구조로 문제없이 애플리케이션 사용 가능
	5. 저렴함(Cheap) : 운영비용이 없어 장기적으로 싸다고 느껴질 수 있음

##### ELB 작동 방식
- ELB는 다중 AZ 환경에 구현. - VPC 내 알아서 해줌
##### 로드 밸런서 유형 (3 +1)
- Network Load Balancer : TCP 로드 밸런서라고도 부르며 4계층에서 작동. 즉 ip+ port + protocol에 따라 분배. 패킷의 내용은 보지 않음. NLB의 프록시 프로토콜을 통해 패킷의 원본 주소가 타겟에 전달됨.
- Application Load Balancer : 7계층에서 작동. Http/s 헤더,경로,쿠키를 해석할 수 있으므로 경로 기반 라우팅 및 호스트 기반 라우팅이 가능.
- Classic Load Balancer (이전 세대):  L4,L7 기능 동시 제공. 하지만 ALB 처럼 세밀한 경로/조건 기반 라우팅이나 NLB 처럼 초저지연 성능은 제공하지 못함. 오직 L4 수준의 분산과 세션 유지 정도만 가능.

| 특성                        | Application Load Balancer | Network Load Balancer | Classic Load Balancer |
| ------------------------- | ------------------------- | --------------------- | --------------------- |
| 프로토콜                      | HTTP, HTTPS               | TCP                   | TCP, SSL, HTTP, HTTPS |
| 플랫폼                       | VPC                       | VPC                   | EC2-Classic, VPC      |
| 헬스 체크                     | ✔                         | ✔                     | ✔                     |
| CloudWatch 성능 지표          | ✔                         | ✔                     | ✔                     |
| 로그 기록                     | ✔                         | ✔                     | ✔                     |
| AZ간 실패대응                  | ✔                         | ✔                     | ✔                     |
| 연결 비용(등록해제 지연기능)          | ✔                         | ✔                     | ✔                     |
| 동일 인스턴스에 대한 다중 포트의 로드 밸런싱 | ✔                         | ✔                     | ✘                     |
| 웹소켓                       | ✔                         | ✔                     | ✘                     |
| 대상으로서 IP 주소               | ✔                         | ✔                     | ✘                     |
| 로드 밸런서 삭제 보호              | ✔                         | ✔                     | ✘                     |
| 경로 기반 라우팅                 | ✔                         | ✘                     | ✘                     |
| 호스트 기반 라우팅                | ✔                         | ✘                     | ✘                     |
| 네이티브 HTTP/2               | ✔                         | ✘                     | ✘                     |
| 연결 대기 시간 설정               | ✔                         | ✘                     | ✔                     |
| AZ간 로드 밸런싱                | ✔                         | ✘                     | ✔                     |
| SSL 오프로딩                  | ✔                         | ✘                     | ✔                     |
| 스티키 세션(Sticky sessions)   | ✔                         | ✘                     | ✔                     |
| 백엔드 서버 암호화                | ✔                         | ✘                     | ✔                     |
| 정적 IP                     | ✘                         | ✔                     | ✘                     |
| 일래스틱 IP 주소                | ✘                         | ✔                     | ✘                     |
| 소스 IP 주소 보관               | ✘                         | ✔                     | ✘                     |
  ※ 로드 밸런서는 외부에 노출이므로 보안에 신경써야 함.

- **Gateway Load Balancer (GWLB) : 3계층 (only IP)** 에 동작하는 특수 로드 밸런서 
	- 목적: **보안·관찰 장비(가상 어플라이언스)** 를 트래픽 경로에 투명하게 삽입(Transparent Insertion)하고, 그 장비들에 **로드 밸런싱 기능**을 제공.
	- 구성요소
		1. **GWLB 본체**
		   - 트래픽을 받아서 보안 장비(Target Group)로 분산.
		   - 검사된 패킷을 다시 받아 원래 목적지로 전달.
		2. Target Group
		   - IDS/IPS, 방화벽, DLP, 트래픽 모니터링 장비 등.
		   - 실제 보안 검사/분석 수행.
		3. GWLBE (Gateway Load Balancer Endpoint)
		   - VPC 내부에서 GWLB를 연결하는 “진입점(Next Hop)” 역할.
		   - 라우팅 테이블에서 특정 목적지 CIDR을 GWLBE로 지정하면, 트래픽이 자동으로 GWLB로 향함.
		4. GENEVE 프로토콜(포트 6081)
		   - GWLB ↔ 보안 장비 간 트래픽 전달용 캡슐화 프로토콜.
		   - 패킷의 원본 IP/Port/Protocol을 그대로 유지해 보안 장비가 원본 패킷을 분석 가능.
	- 동작흐름
		1.  사용자가 서비스 엔드포인트(ALB,NLB,CLB)에 요청 송신
		2.  VPC 라우팅 테이블에서 해당 트래픽을 GWLBE로 경유하도록 전달.
		3. GWLBE에서 GWLB로 트래픽 전달
		4. GWLB가 타겟 그룹(보안 장비) 중 하나로 로드밸런싱
		5. 보안 장비에서 패킷 검사/제어 수행
		6. 보안 장비가 결과를 GWLB에 반환
		7. GWLB가 캡슐화를 풀고 원래 목적지에 트래픽 전달
	※ 사용자는 보안 장비를 거쳣다는 사실은 모름.
	※ 위의 3가지는 서비스형 LB, GWLB는 보안 계층형 LB 

---
#### 로드 밸런서의 핵심 개념과 용어